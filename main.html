<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸŒ± ç”°é–“è§€å¯Ÿæ—¥èªŒï¼ˆæ¨¡æ¿Cï¼‰â€” å–®æª”ç‰ˆ</title>
  <meta name="description" content="å–®ä¸€HTMLæª”ï¼Œå¯è¨˜éŒ„ä½œç‰©è§€å¯Ÿã€ç”°é–“æ“ä½œã€æŒ‡æ¨™èˆ‡ä¼°ç”¢ã€è¡Œå‹•æ¸…å–®èˆ‡åª’é«”ï¼Œæ”¯æ´æœ¬æ©Ÿè‡ªå‹•å„²å­˜ã€Markdown åŒ¯å‡ºèˆ‡åˆ—å°ã€‚" />
  <style>
    :root {
      --bg:#0b1020; --card:#111936; --muted:#9fb0ff; --text:#e8ecff; --accent:#7aa2ff; --accent2:#9a7bff;
      --ok:#87ffb0; --warn:#ffd36b; --red:#ff8ea1; --line:#213162; --chip:#1a2454; --field:#091024;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:linear-gradient(180deg,#0b1020,#0a0f1c)}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;flex-wrap:wrap;align-items:center;gap:12px;justify-content:space-between;margin-bottom:16px}
    .title{display:flex;align-items:center;gap:10px}
    h1{font-size:22px;margin:0;letter-spacing:.5px}
    .badge{font-size:12px;opacity:.8;padding:4px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--line)}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    button, .ghost {cursor:pointer;padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:var(--chip);color:var(--text);transition:.15s;box-shadow:0 0 0 rgba(0,0,0,0)}
    button:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(10,15,40,.3)}
    button.primary{background:linear-gradient(180deg,#7aa2ff,#9a7bff)}
    button.warn{background:linear-gradient(180deg,#ffd36b,#ff8ea1);color:#1b1620}
    .ghost{background:transparent;opacity:.85}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:860px){.g2,.g3{grid-template-columns:1fr}}
    section.card{background:var(--card);border:1px solid var(--line);border-radius:20px;padding:16px}
    section.card h2{margin:0 0 10px 0;font-size:18px}
    label{font-size:13px;opacity:.9;display:block;margin:4px 0}
    input[type="text"], input[type="date"], input[type="time"], input[type="number"], textarea, select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:var(--field);color:var(--text)}
    textarea{min-height:84px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}
    .subtle{font-size:12px;opacity:.75}
    .hint{font-size:12px;opacity:.85;background:#0e1530;border:1px dashed var(--line);padding:8px 10px;border-radius:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--line);background:#0d1530;border-radius:14px;padding:10px}
    .item .row{align-items:flex-end}
    .status{font-size:12px;opacity:.7}
    .right{margin-left:auto}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{background:var(--chip);border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:12px}
    .kv{display:grid;gap:10px;grid-template-columns:160px 1fr}
    @media (max-width:700px){.kv{grid-template-columns:1fr}}
    footer{opacity:.7;padding:20px 0;font-size:12px;text-align:center}
    .save-ind{font-size:12px;opacity:.75}

    /* Table-like list */
    .table{display:grid;grid-template-columns:1.2fr .8fr .8fr .8fr auto;gap:8px;align-items:end}
    .table .th{font-size:12px;opacity:.7}
    .table .row{display:contents}

    /* Media gallery */
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
    .thumb{position:relative;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .thumb img{width:100%;display:block}
    .thumb .x{position:absolute;top:6px;right:6px;background:rgba(0,0,0,.5);border:1px solid var(--line);color:#fff;border-radius:10px;padding:2px 6px;font-size:12px;cursor:pointer}

    /* Print */
    @media print{
      body{background:#fff;color:#000}
      header .toolbar, .hint, .subtle, .badge, .ghost{display:none !important}
      section.card{border:1px solid #ccc}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>ğŸŒ± ç”°é–“è§€å¯Ÿæ—¥èªŒï¼ˆæ¨¡æ¿Cï¼‰</h1>
        <span class="badge">Single-file â€¢ Auto-save â€¢ Markdown Export</span>
      </div>
      <div class="toolbar">
        <button class="primary" id="btnSave">Save</button>
        <button id="btnExport">Export Markdown</button>
        <button id="btnPrint">Print</button>
        <button class="ghost" id="btnDemo">Load Demo</button>
        <button class="warn" id="btnClear">Clear</button>
      </div>
    </header>

    <div class="subtle" id="saveState">å°šæœªå„²å­˜</div>

    <!-- Top meta fields -->
    <section class="card">
      <h2>åŸºæœ¬è³‡è¨Š</h2>
      <div class="grid g3">
        <div>
          <label>æ—¥æœŸ Date</label>
          <input type="date" id="date" />
        </div>
        <div>
          <label>ä½œç‰© Crop</label>
          <input type="text" id="crop" placeholder="ä¾‹ï¼šé¹¿è§’èµè‹£ / ç«é¾æœ" />
        </div>
        <div>
          <label>å€ä½ Field / Greenhouse</label>
          <input type="text" id="field" placeholder="ä¾‹ï¼šGH-A å€ã€è©¦é©—ç•¦ #3" />
        </div>
        <div>
          <label>æ°£å€™ Weather</label>
          <input type="text" id="weather" placeholder="ä¾‹ï¼šæ™´ 33â„ƒï¼›ç›¸å°æ¿•åº¦ 70%ï¼›é¢¨é€Ÿ 2m/s" />
        </div>
        <div>
          <label>ç”Ÿè‚²æœŸ Phenology</label>
          <select id="phenology">
            <option value="">â€” è«‹é¸æ“‡ â€”</option>
            <option>è‚²è‹—</option><option>å®šæ¤</option><option>ç‡Ÿé¤Šç”Ÿé•·</option>
            <option>é–‹èŠ±</option><option>è‘—æœ/è†¨å¤§</option><option>è½‰è‰²/æˆç†Ÿ</option>
            <option>æ¡æ”¶</option>
          </select>
        </div>
        <div>
          <label>ç—…èŸ²ï¼é€†å¢ƒ Issues</label>
          <input type="text" id="issues" placeholder="ä¾‹ï¼šç™½ç²‰ç—…ã€èšœèŸ²ï¼›é«˜æº«ã€ä¹¾æ—±" />
        </div>
      </div>
      <p class="hint" style="margin-top:10px">æç¤ºï¼šä»¥ä¸Šæ¬„ä½å°‡ä½œç‚ºåŒ¯å‡º Markdown çš„æ¨™é¡Œèˆ‡æ¨™ç±¤ä¾æ“šã€‚</p>
    </section>

    <!-- ä»Šæ—¥è§€å¯Ÿ -->
    <section class="card">
      <h2>ä»Šæ—¥è§€å¯Ÿ</h2>
      <div class="grid g2">
        <div>
          <label>ç”Ÿé•·ç‹€æ³</label>
          <textarea id="obsGrowth" placeholder="ä¾‹ï¼šæ ªé«˜ 18â€“22cmï¼Œç¯€é–“é•· 3cmï¼Œåˆ†æ 1â€“2"></textarea>
        </div>
        <div>
          <label>è‘‰è‰²ï¼è‘‰å½¢</label>
          <textarea id="obsLeaf" placeholder="ä¾‹ï¼šè‘‰è‰²æ¿ƒç¶ ï¼›æ–°è‘‰å¾®æ²ï¼Œè‘‰ç·£å®Œæ•´ç„¡ç¼ºåˆ»"></textarea>
        </div>
        <div>
          <label>åœŸå£¤ï¼ä»‹è³ªè§€æ„Ÿ</label>
          <textarea id="obsSoil" placeholder="ä¾‹ï¼šè¡¨å±¤ç•¥ä¹¾ã€æ‰‹è§¸æ¿•æ½¤ï¼›EC 1.2 mS/cmï¼›pH 6.2"></textarea>
        </div>
        <div>
          <label>å…¶ä»–</label>
          <textarea id="obsOther" placeholder="ä¾‹ï¼šå°‘é‡æ•æ‰åˆ°æ£˜èƒ¸è …ï¼›æº«å®¤åŒ—å´é®è”­å¸ƒé¬†è„«"></textarea>
        </div>
      </div>
    </section>

    <!-- ä»Šæ—¥æ“ä½œ -->
    <section class="card">
      <h2>ä»Šæ—¥æ“ä½œ</h2>
      <div class="list" id="opsList"></div>
      <div class="row" style="margin-top:10px">
        <button id="addOp">ï¼‹ æ–°å¢æ“ä½œ</button>
        <span class="subtle">å»ºè­°ç´€éŒ„é¡å‹ã€åŠ‘é‡ã€æ™‚é–“èˆ‡å‚™è¨»ã€‚</span>
      </div>
    </section>

    <!-- æŒ‡æ¨™èˆ‡ä¼°ç”¢ -->
    <section class="card">
      <h2>æŒ‡æ¨™ & ä¼°ç”¢</h2>
      <div class="table" id="metTable">
        <div class="th">æŒ‡æ¨™åç¨±</div>
        <div class="th">æ•¸å€¼</div>
        <div class="th">å–®ä½</div>
        <div class="th">æ™‚é–“</div>
        <div class="th"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="addMetric">ï¼‹ æ–°å¢é‡æ¸¬</button>
        <input class="right" type="text" id="yieldEst" placeholder="åˆæ­¥ä¼°ç”¢ï¼ˆä¾‹ï¼šæ¯ç•¦ 8â€“10kgï¼›èª¤å·® Â±10%ï¼‰" />
      </div>
    </section>

    <!-- è¡Œå‹•æ¸…å–® -->
    <section class="card">
      <h2>Action Itemsï¼ˆä¸‹ä¸€æ­¥ï¼‰</h2>
      <div id="todoList" class="list"></div>
      <div class="row" style="margin-top:10px">
        <button id="addTodo">ï¼‹ æ–°å¢ä»»å‹™</button>
        <span class="subtle">æ¯å€‹ä»»å‹™å¯å‹¾é¸å®Œæˆç‹€æ…‹ä¸¦è¨­å®šåˆ°æœŸæ—¥ã€‚</span>
      </div>
    </section>

    <!-- åª’é«”èˆ‡é€£çµ -->
    <section class="card">
      <h2>åª’é«”</h2>
      <div class="hint">å»ºè­°é™„ä¸Šé›²ç«¯é€£çµç¯€çœç©ºé–“ï¼ˆå¤§å‹åª’é«”ä¸æœƒå¯«å…¥æœ¬æ©Ÿå„²å­˜ä»¥é¿å…è¶…éç€è¦½å™¨ä¸Šé™ï¼‰ã€‚</div>
      <div class="row" style="margin:10px 0">
        <input type="file" id="mediaInput" accept="image/*,video/*" multiple />
        <input type="text" id="refLinks" placeholder="é€£çµï¼ˆä»¥ç©ºç™½åˆ†éš”å¤šå€‹ URLï¼‰" />
      </div>
      <div id="gallery" class="gallery"></div>
    </section>

    <!-- è‡ªæˆ‘æª¢æŸ¥ -->
    <section class="card">
      <h2>Self-checkï¼ˆæœ€å°æ¸¬è©¦ï¼‰</h2>
      <div class="row">
        <button id="btnSelfCheck">Run Self-Check</button>
        <div class="subtle">æœƒæª¢æŸ¥æ˜¯å¦å«æ¨™é¡Œã€å¿…å¡«æ¬„ä½ï¼ˆæ—¥æœŸã€ä½œç‰©ï¼‰èˆ‡ Markdown åŒ¯å‡ºæ ¸å¿ƒæ®µè½ã€‚</div>
      </div>
      <div id="checkResult" class="hint" style="margin-top:10px"></div>
    </section>

    <footer>
      ç”°é–“è§€å¯Ÿæ—¥èªŒï¼ˆæ¨¡æ¿Cï¼‰â€” å–®æª”ç‰ˆ â€¢ æœ¬æ©Ÿä¿å­˜ï¼ˆlocalStorageï¼‰ â€¢ ç„¡éœ€å¾Œç«¯ â€¢ ç”±ã€Œæ¨¡æ¿Cã€è½‰ç‚ºäº’å‹•è¡¨å–®
    </footer>
  </div>

  <script>
  // ===== Utility: date helpers (Asia/Taipei friendly by relying on local time) =====
  function todayStr(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const t = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${t}`;
  }

  // ===== DOM refs =====
  const $ = (s,root=document)=>root.querySelector(s);
  const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));

  const date = $('#date');
  const crop = $('#crop');
  const field = $('#field');
  const weather = $('#weather');
  const phenology = $('#phenology');
  const issues = $('#issues');
  const obsGrowth = $('#obsGrowth');
  const obsLeaf = $('#obsLeaf');
  const obsSoil = $('#obsSoil');
  const obsOther = $('#obsOther');
  const opsList = $('#opsList');
  const metTable = $('#metTable');
  const yieldEst = $('#yieldEst');
  const todoList = $('#todoList');
  const refLinks = $('#refLinks');
  const mediaInput = $('#mediaInput');
  const gallery = $('#gallery');

  const btnSave = $('#btnSave');
  const btnExport = $('#btnExport');
  const btnPrint = $('#btnPrint');
  const btnDemo = $('#btnDemo');
  const btnClear = $('#btnClear');
  const btnAddOp = $('#addOp');
  const btnAddMetric = $('#addMetric');
  const btnAddTodo = $('#addTodo');
  const btnSelfCheck = $('#btnSelfCheck');
  const saveState = $('#saveState');
  const checkResult = $('#checkResult');

  // ===== Auto init =====
  if(!date.value) date.value = todayStr();

  // ===== Dynamic builders =====
  function opItem(data={type:'æ¾†çŒ', dose:'', time:'', notes:''}){
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `
      <div class="row">
        <div>
          <label>é¡å‹</label>
          <select class="op-type">
            <option ${data.type==='æ¾†çŒ'?'selected':''}>æ¾†çŒ</option>
            <option ${data.type==='æ–½è‚¥'?'selected':''}>æ–½è‚¥</option>
            <option ${data.type==='æ•´æ'?'selected':''}>æ•´æ</option>
            <option ${data.type==='èª˜æ®º'?'selected':''}>èª˜æ®º</option>
            <option ${data.type==='ç’°æ§'?'selected':''}>ç’°æ§</option>
            <option ${data.type==='å…¶ä»–'?'selected':''}>å…¶ä»–</option>
          </select>
        </div>
        <div>
          <label>åŠ‘é‡ / é…æ–¹</label>
          <input type="text" class="op-dose" placeholder="ä¾‹ï¼šAæ¶² 1.5mL/Lï¼›500mL/æ ª" value="${data.dose||''}">
        </div>
        <div>
          <label>æ™‚é–“</label>
          <input type="time" class="op-time" value="${data.time||''}">
        </div>
        <button class="ghost right op-del">åˆªé™¤</button>
      </div>
      <label>å‚™è¨»</label>
      <input type="text" class="op-notes" placeholder="ä¾‹ï¼šå—å´ 1â€“3 ç•¦ï¼›è‘‰èƒŒå‡å‹»å™´å¸ƒ" value="${data.notes||''}">
    `;
    el.querySelector('.op-del').onclick = ()=>{ el.remove(); touched(); };
    return el;
  }

  function metricRow(data={name:'', value:'', unit:'', time:''}){
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <input type="text" class="met-name" placeholder="ä¾‹ï¼šEC / pH / æ ªé«˜ / Brix" value="${data.name||''}">
      <input type="text" class="met-value" placeholder="æ•¸å€¼" value="${data.value||''}">
      <input type="text" class="met-unit" placeholder="å–®ä½ï¼ˆä¾‹ï¼šmS/cmã€cmã€Â°Bxï¼‰" value="${data.unit||''}">
      <input type="time" class="met-time" value="${data.time||''}">
      <button class="ghost met-del">åˆªé™¤</button>
    `;
    row.querySelector('.met-del').onclick = ()=>{ row.remove(); touched(); };
    metTable.appendChild(row);
  }

  function todoItem(data={text:'', due:'', done:false}){
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `
      <div class="row">
        <div style="flex:0 0 auto"><input type="checkbox" class="todo-done" ${data.done? 'checked':''}></div>
        <input type="text" class="todo-text" placeholder="ä»»å‹™å…§å®¹" value="${data.text||''}">
        <input type="date" class="todo-due" value="${data.due||''}">
        <button class="ghost todo-del">åˆªé™¤</button>
      </div>
    `;
    el.querySelector('.todo-del').onclick = ()=>{ el.remove(); touched(); };
    return el;
  }

  // Seed one row each
  opsList.appendChild(opItem());
  metricRow({});
  todoList.appendChild(todoItem({}));

  // Adders
  btnAddOp.onclick = ()=>{ opsList.appendChild(opItem()); touched(); };
  btnAddMetric.onclick = ()=>{ metricRow({}); touched(); };
  btnAddTodo.onclick = ()=>{ todoList.appendChild(todoItem({})); touched(); };

  // ===== Media handling (preview only; not persisted to localStorage) =====
  mediaInput.addEventListener('change', async (e)=>{
    gallery.innerHTML = '';
    const files = Array.from(e.target.files||[]).slice(0,24);
    for(const f of files){
      const url = URL.createObjectURL(f);
      const box = document.createElement('div');
      box.className='thumb';
      let inner = '';
      if(f.type.startsWith('image/')) inner = `<img alt="${f.name}">`;
      else inner = `<div style="aspect-ratio:1/1;display:grid;place-items:center;padding:20px">ğŸ“¹ ${f.name}</div>`;
      box.innerHTML = inner + '<div class="x">Ã—</div>';
      if(box.firstChild && box.firstChild.tagName==='IMG') box.firstChild.src = url;
      box.querySelector('.x').onclick = ()=> box.remove();
      gallery.appendChild(box);
    }
  });

  // ===== Save / Load (localStorage) =====
  const KEY = 'farm-log-v1';

  function serialize(){
    const ops = $$('.item', opsList).map(it=>({
      type: $('.op-type', it).value,
      dose: $('.op-dose', it).value,
      time: $('.op-time', it).value,
      notes: $('.op-notes', it).value,
    }));
    const mets = [];
    $$('.row', metTable).forEach(r=>{
      const n = $('.met-name', r); if(!n) return; // skip header
      mets.push({
        name: n.value,
        value: $('.met-value', r).value,
        unit: $('.met-unit', r).value,
        time: $('.met-time', r).value,
      });
    });
    const todos = $$('.item', todoList).map(it=>({
      done: $('.todo-done', it).checked,
      text: $('.todo-text', it).value,
      due: $('.todo-due', it).value,
    }));
    return {
      date: date.value, crop: crop.value, field: field.value,
      weather: weather.value, phenology: phenology.value, issues: issues.value,
      obs:{growth:obsGrowth.value, leaf:obsLeaf.value, soil:obsSoil.value, other:obsOther.value},
      ops, metrics: mets, yieldEst: yieldEst.value, todos,
      links: (refLinks.value||'').trim(),
    };
  }

  function deserialize(d){
    if(!d) return;
    date.value = d.date || todayStr();
    crop.value = d.crop || '';
    field.value = d.field || '';
    weather.value = d.weather || '';
    phenology.value = d.phenology || '';
    issues.value = d.issues || '';
    obsGrowth.value = d.obs?.growth || '';
    obsLeaf.value = d.obs?.leaf || '';
    obsSoil.value = d.obs?.soil || '';
    obsOther.value = d.obs?.other || '';

    opsList.innerHTML = '';
    (d.ops||[]).forEach(o=>opsList.appendChild(opItem(o)));
    if(!d.ops || d.ops.length===0) opsList.appendChild(opItem({}));

    // Reset metric table (keep header)
    $$('.row', metTable).forEach((r,i)=>{ if(i>0) r.remove(); });
    (d.metrics||[]).forEach(m=>metricRow(m));
    if(!d.metrics || d.metrics.length===0) metricRow({});

    todoList.innerHTML='';
    (d.todos||[]).forEach(t=>todoList.appendChild(todoItem(t)));
    if(!d.todos || d.todos.length===0) todoList.appendChild(todoItem({}));

    yieldEst.value = d.yieldEst || '';
    refLinks.value = d.links || '';
  }

  function save(){
    const data = serialize();
    localStorage.setItem(KEY, JSON.stringify(data));
    saveState.textContent = 'å·²å„²å­˜æ–¼æœ¬æ©Ÿï¼š' + new Date().toLocaleString();
  }

  function load(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return;
    try{ deserialize(JSON.parse(raw)); saveState.textContent = 'å·²è¼‰å…¥æœ¬æ©Ÿè‰ç¨¿'; }
    catch(err){ console.error(err); }
  }

  function clearAll(){
    if(confirm('æ¸…ç©ºæ‰€æœ‰æ¬„ä½ä¸¦åˆªé™¤æœ¬æ©Ÿå„²å­˜ï¼Ÿ')){
      localStorage.removeItem(KEY);
      location.reload();
    }
  }

  btnSave.onclick = save;
  btnClear.onclick = clearAll;
  btnPrint.onclick = ()=> window.print();

  // Auto-save (debounced)
  let timer;
  function touched(){
    saveState.textContent = 'è®Šæ›´æœªå„²å­˜â€¦';
    clearTimeout(timer);
    timer = setTimeout(save, 800);
  }
  document.addEventListener('input', touched, true);
  document.addEventListener('change', touched, true);

  // ===== Markdown Export =====
  function toMarkdown(){
    const d = serialize();
    if(!d.date || !d.crop){
      alert('è«‹å…ˆå¡«å¯«ã€Œæ—¥æœŸã€èˆ‡ã€Œä½œç‰©ã€ï¼Œå†åŒ¯å‡º Markdown');
      return '';
    }
    const head = `# ğŸŒ± ç”°é–“è§€å¯Ÿ â€” ${d.date}\n**Cropï¼ˆä½œç‰©ï¼‰**ï¼š ${d.crop}  \n**Field / Greenhouseï¼ˆå€ä½ï¼‰**ï¼š ${d.field||''}  \n**Weatherï¼ˆæ°£å€™ï¼‰**ï¼š ${d.weather||''}  \n**Phenologyï¼ˆç”Ÿè‚²æœŸï¼‰**ï¼š ${d.phenology||''}  \n**Issuesï¼ˆç—…èŸ²ï¼é€†å¢ƒï¼‰**ï¼š ${d.issues||''}`;

    const obs = `\n\n## ä»Šæ—¥è§€å¯Ÿ\n- ç”Ÿé•·ç‹€æ³ï¼š${d.obs.growth||''}\n- è‘‰è‰²ï¼è‘‰å½¢ï¼š${d.obs.leaf||''}\n- åœŸå£¤ï¼ä»‹è³ªè§€æ„Ÿï¼š${d.obs.soil||''}\n- å…¶ä»–ï¼š${d.obs.other||''}`;

    const ops = d.ops.map(o=>`- ${o.type}ï½œ${o.dose||''}ï½œ${o.time||''}ï½œ${o.notes||''}`).join('\n');
    const opsSec = `\n\n## ä»Šæ—¥æ“ä½œ\n${ops || '- ï¼ˆç„¡ï¼‰'}`;

    const met = d.metrics.map(m=>`- ${m.name||''}ï¼š${m.value||''} ${m.unit||''}ï¼ˆ${m.time||''}ï¼‰`).join('\n');
    const metSec = `\n\n## æŒ‡æ¨™ & ä¼°ç”¢\n${met || '- ï¼ˆç„¡ï¼‰'}\n- åˆæ­¥ä¼°ç”¢ï¼š${d.yieldEst||''}`;

    const todos = d.todos.map(t=>`- [${t.done?'x':' '}] ${t.text||''}ï¼ˆDueï¼š${t.due||''}ï¼‰`).join('\n');
    const todoSec = `\n\n## Action Itemsï¼ˆä¸‹ä¸€æ­¥ï¼‰\n${todos || '- [ ] ï¼ˆç„¡ï¼‰'}`;

    const media = `\n\n## åª’é«”\n${(d.links||'').split(/\s+/).filter(Boolean).map(u=>`- ${u}`).join('\n') || '- ï¼ˆè²¼ä¸Šç…§ç‰‡ / å½±ç‰‡ / æ„Ÿæ¸¬åœ–è¡¨é€£çµï¼‰'}`;

    return [head, obs, opsSec, metSec, todoSec, media].join('\n');
  }

  btnExport.onclick = ()=>{
    const md = toMarkdown();
    if(!md) return;
    const blob = new Blob([md], {type:'text/markdown;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const name = `farm-log_${date.value||todayStr()}_${(crop.value||'crop').replace(/\s+/g,'-')}.md`;
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);
  };

  // ===== Demo data for quick trial =====
  btnDemo.onclick = ()=>{
    const demo = {
      date: todayStr(), crop:'é¹¿è§’èµè‹£', field:'GH-A è©¦é©—ç•¦ #3',
      weather:'æ™´ 33â„ƒï¼›RH 70%ï¼›é¢¨ 2m/s', phenology:'ç‡Ÿé¤Šç”Ÿé•·', issues:'èšœèŸ²å°‘é‡ï¼›åˆå¾Œé«˜æº«',
      obs:{growth:'æ ªé«˜ 20cmï¼Œç¯€é–“ 2.8â€“3.2cmï¼›å´èŠ½ 1â€“2ã€‚', leaf:'è‘‰è‰²å‡ä¸€æ¿ƒç¶ ï¼›æ–°è‘‰å¾®æ²ã€‚', soil:'è¡¨å±¤ç•¥ä¹¾ï¼›EC 1.2 mS/cmï¼›pH 6.2ã€‚', other:'åŒ—å´é®è”­å¸ƒé¬†è„«ï¼Œå·²æš«æ™‚å›ºå®šã€‚'},
      ops:[{type:'æ¾†çŒ', dose:'500mL/æ ª', time:'09:30', notes:'å—å´ 1â€“3 ç•¦'}, {type:'æ–½è‚¥', dose:'Aæ¶² 1.5mL/L', time:'09:40', notes:'éš¨æ°´å‡å‹»ä¾›çµ¦'}],
      metrics:[{name:'EC', value:'1.2', unit:'mS/cm', time:'10:00'},{name:'pH', value:'6.2', unit:'', time:'10:00'},{name:'æ ªé«˜', value:'20', unit:'cm', time:'10:05'}],
      yieldEst:'æ¯ç•¦ 8â€“10 kgï¼›èª¤å·® Â±10%',
      todos:[{text:'æ›´æ›åŒ—å´é®è”­å¸ƒæ‰£å…·', due: todayStr(), done:false},{text:'ä¸‹é€±è¤‡æŸ¥èšœèŸ²å¯†åº¦', due: todayStr(), done:false}],
      links:'https://example.com/sensor/ec https://example.com/photos/2025-08-23'
    };
    deserialize(demo); touched();
  };

  // ===== Self-check (minimal tests) =====
  btnSelfCheck.onclick = ()=>{
    const md = toMarkdown();
    if(!md){ checkResult.textContent = 'âŒ ç¼ºå°‘å¿…å¡«æ¬„ä½'; return; }
    const must = ['# ğŸŒ± ç”°é–“è§€å¯Ÿ â€”', '## ä»Šæ—¥è§€å¯Ÿ', '## ä»Šæ—¥æ“ä½œ', '## æŒ‡æ¨™ & ä¼°ç”¢', '## Action Itemsï¼ˆä¸‹ä¸€æ­¥ï¼‰', '## åª’é«”'];
    const miss = must.filter(m=>!md.includes(m));
    if(miss.length){
      checkResult.textContent = 'âš ï¸ æª¢æŸ¥æœªé€šéï¼Œç¼ºå°‘æ®µè½ï¼š' + miss.join('ã€');
    }else{
      checkResult.textContent = 'âœ… æª¢æŸ¥é€šéï¼šMarkdown çµæ§‹å®Œæ•´';
    }
  };

  // Load persisted data on start
  load();
  </script>
</body>
</html>
